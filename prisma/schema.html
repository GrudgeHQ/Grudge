generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CAPTAIN
  CO_CAPTAIN
  COACH
  COORDINATOR
  MEMBER
}

enum AvailabilityStatus {
  AVAILABLE
  MAYBE
  UNAVAILABLE
}

enum Sport {
  SOCCER
  BASKETBALL
  BASEBALL
  FOOTBALL
  VOLLEYBALL
  TENNIS
  BADMINTON
  RUGBY
  HOCKEY
  ICE_HOCKEY
  FIELD_HOCKEY
  LACROSSE
  CRICKET
  GOLF
  SWIMMING
  TRACK
  CYCLING
  BOXING
  MMA
  WRESTLING
  TABLE_TENNIS
  SQUASH
  PICKLEBALL
  HANDBALL
  SKIING
  SNOWBOARDING
  SURFING
  ROWING
  SAILING
  KAYAKING
  BOWLING
  DODGEBALL
  KICKBALL
  ULTIMATE_FRISBEE
  WATER_POLO
  POLO
  PING_PONG
}

model User {
  id             String      @id @default(cuid())
  name           String?
  email          String?     @unique
  emailVerified  DateTime?
  password       String?     // hashed password (optional if using OAuth)
  phone          String?
  bio            String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  memberships    TeamMember[]
  sentInvitations Invitation[] @relation("Inviter")
  invitations    Invitation[] @relation("Invitee")
  messages       ChatMessage[]
  createdPractices Practice[] @relation("PracticeCreatedBy")
  proposedPractices Practice[] @relation("PracticeProposedBy")
  createdMatches   Match[]   @relation("MatchCreatedBy")
  createdScrimmages Scrimmage[] @relation("ScrimmageCreatedBy")
  createdLeagues   League[]  @relation("LeagueCreatedBy")
  notifications    Notification[]
  availabilities Availability[]
  assignments    Assignment[] @relation("AssignedTo")
  assignedTasks  Assignment[] @relation("AssignedBy")
  auditLogs     AuditLog[]
}

model Team {
  id          String       @id @default(cuid())
  name        String       @unique
  sport       Sport
  inviteCode  String       @unique
  password    String?      // optional team password
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  members     TeamMember[]
  matches     Match[] @relation("TeamMatches")
  opponentMatches Match[] @relation("OpponentMatches")
  practices   Practice[]
  scrimmages  Scrimmage[]
  chats       ChatMessage[]
  leagues     LeagueTeam[]
  invitations Invitation[]
  leagueHomeMatches LeagueMatch[] @relation("LeagueHome")
  leagueAwayMatches LeagueMatch[] @relation("LeagueAway")
  notifications    Notification[]
  auditLogs    AuditLog[]
}

model TeamMember {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  team      Team     @relation(fields: [teamId], references: [id])
  teamId    String
  role      Role     @default(MEMBER)
  isAdmin   Boolean  @default(false)
  joinedAt  DateTime @default(now())

  @@unique([userId, teamId])
}

model Invitation {
  id          String   @id @default(cuid())
  code        String   @unique
  password    String?  // team-level password to join
  team        Team     @relation(fields: [teamId], references: [id])
  teamId      String
  invitedBy   User?    @relation("Inviter", fields: [invitedById], references: [id])
  invitedById String?
  invitee     User?    @relation("Invitee", fields: [inviteeId], references: [id])
  inviteeId   String?
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  accepted    Boolean  @default(false)
}

model Match {
  id           String    @id @default(cuid())
  team         Team      @relation("TeamMatches", fields: [teamId], references: [id])
  teamId       String
  opponentName String?
  opponentTeam Team?     @relation("OpponentMatches", fields: [opponentTeamId], references: [id])
  opponentTeamId String?
  scheduledAt  DateTime
  location     String?
  createdBy    User?     @relation("MatchCreatedBy", fields: [createdById], references: [id])
  createdById  String?
  homeScore    Int?
  awayScore    Int?
  createdAt    DateTime  @default(now())

  availabilities Availability[]
  assignments    Assignment[]
}

model Availability {
  id        String             @id @default(cuid())
  match     Match              @relation(fields: [matchId], references: [id])
  matchId   String
  user      User               @relation(fields: [userId], references: [id])
  userId    String
  status    AvailabilityStatus @default(MAYBE)
  notes     String?
  updatedAt DateTime           @updatedAt

  @@unique([matchId, userId])
}

model Assignment {
  id          String   @id @default(cuid())
  match       Match    @relation(fields: [matchId], references: [id])
  matchId     String
  user        User     @relation("AssignedTo", fields: [userId], references: [id])
  userId      String
  assignedBy  User?    @relation("AssignedBy", fields: [assignedById], references: [id])
  assignedById String?
  assignedAt  DateTime @default(now())
  confirmed   Boolean  @default(false)
  confirmedAt DateTime?

  @@unique([matchId, userId])
}

model Practice {
  id         String   @id @default(cuid())
  team       Team     @relation(fields: [teamId], references: [id])
  teamId     String
  scheduledAt DateTime
  location   String?
  createdBy  User?    @relation("PracticeCreatedBy", fields: [createdById], references: [id])
  createdById String?
  approved   Boolean  @default(false)
  proposedBy User?    @relation("PracticeProposedBy", fields: [proposedById], references: [id])
  proposedById String?
  createdAt  DateTime @default(now())
}

model Scrimmage {
  id            String   @id @default(cuid())
  team          Team     @relation(fields: [teamId], references: [id])
  teamId        String
  name          String?
  settings      Json?
  createdBy     User?    @relation("ScrimmageCreatedBy", fields: [createdById], references: [id])
  createdById   String?
  createdAt     DateTime @default(now())
}

model League {
  id        String    @id @default(cuid())
  name      String
  sport     Sport
  creator   User?     @relation("LeagueCreatedBy", fields: [creatorId], references: [id])
  creatorId String?
  createdAt DateTime  @default(now())

  teams     LeagueTeam[]
  matches   LeagueMatch[]
}

model LeagueTeam {
  id       String @id @default(cuid())
  league   League @relation(fields: [leagueId], references: [id])
  leagueId String
  team     Team   @relation(fields: [teamId], references: [id])
  teamId   String
  joinedAt DateTime @default(now())

  @@unique([leagueId, teamId])
}

model LeagueMatch {
  id          String   @id @default(cuid())
  league      League   @relation(fields: [leagueId], references: [id])
  leagueId    String
  homeTeam    Team     @relation("LeagueHome", fields: [homeTeamId], references: [id])
  homeTeamId  String
  awayTeam    Team     @relation("LeagueAway", fields: [awayTeamId], references: [id])
  awayTeamId  String
  scheduledAt DateTime
  homeScore   Int?
  awayScore   Int?
}

model ChatMessage {
  id        String   @id @default(cuid())
  team      Team     @relation(fields: [teamId], references: [id])
  teamId    String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  content   String
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  team      Team?    @relation(fields: [teamId], references: [id])
  teamId    String?
  type      String
  payload   Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  actor     User?    @relation(fields: [actorId], references: [id])
  actorId   String?
  team      Team?    @relation(fields: [teamId], references: [id])
  teamId    String?
  targetId  String?
  payload   Json?
  createdAt DateTime @default(now())
}
